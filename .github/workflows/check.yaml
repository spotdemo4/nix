name: check

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}

permissions:
  contents: read
  id-token: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.hosts.outputs.hosts }}
    steps:
      - name: Initialize
        uses: spotdemo4/nix-init@a5ea6d41ce120b209d0a58900d2906e1f59c2698 # v1.27.2
        with:
          audience: https://niks3.trev.zip
          shell: check

      - name: Run checks
        run: nix flake check

      - id: hosts
        name: Get hosts
        run: |
          HOSTS=$(nix flake show --json | jq -c '.nixosConfigurations | keys' | jq -c)
          echo "hosts=$HOSTS" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ github.event_name != 'push' }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        host: ${{ fromJSON(needs.check.outputs.hosts) }}
    steps:
      - name: Initialize
        uses: spotdemo4/nix-init@a5ea6d41ce120b209d0a58900d2906e1f59c2698 # v1.27.2
        with:
          audience: https://niks3.trev.zip
          shell: check

      - name: Build packages
        run: |
          nix-fast-build \
            --skip-cached \
            --no-nom \
            --flake ".#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel"

  build-status:
    needs: [check, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Failed
        if: ${{ (contains(needs.*.result, 'failure')) || (contains(needs.*.result, 'cancelled')) }}
        run: exit 1

      - name: Success
        run: echo "All jobs completed successfully."
