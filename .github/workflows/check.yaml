name: check

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}

permissions:
  contents: read

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.list_hosts.outputs.hosts }}
    steps:
      - id: init
        name: Initialize
        uses: spotdemo4/nix-init@e33bbfeb90b9958c0ec55db282c93c0c5605f914 # v1.25.2
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          attic_cache: nixos
          shell: check

      - name: Run checks
        run: nix flake check

      - id: list_hosts
        name: Get hosts
        run: |
          HOSTS=$(nix flake show --json | jq -c '.nixosConfigurations | keys' | jq -c)
          echo "hosts=$HOSTS" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ github.event_name != 'push' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: ${{ fromJSON(needs.check.outputs.hosts) }}
      fail-fast: false
    steps:
      - name: Initialize
        uses: spotdemo4/nix-init@e33bbfeb90b9958c0ec55db282c93c0c5605f914 # v1.25.2
        with:
          attic_token: ${{ secrets.ATTIC_TOKEN }}
          attic_cache: nixos
          shell: check

      - name: Build packages
        run: |
          nix-fast-build \
            --skip-cached \
            --no-nom \
            --flake ".#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel"

  build-status:
    needs: [check, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Failed
        if: ${{ (contains(needs.*.result, 'failure')) || (contains(needs.*.result, 'cancelled')) }}
        run: exit 1

      - name: Success
        run: echo "All jobs completed successfully."
