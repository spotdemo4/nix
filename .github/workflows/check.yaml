name: check

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref }}

permissions:
  contents: read
  id-token: write

jobs:
  check:
    runs-on: ubuntu-latest
    outputs:
      hosts: ${{ steps.hosts.outputs.hosts }}
    steps:
      - name: Initialize
        uses: spotdemo4/nix-init@702dfea250d4f6c157fa35c5bb63b5febdffbf3f # v1.27.1
        with:
          shell: check

      - name: Setup cache
        uses: spotdemo4/niks3-action@main
        with:
          audience: https://niks3.trev.zip
          max-concurrent-uploads: 1

      - name: Run checks
        run: nix flake check

      - id: hosts
        name: Get hosts
        run: |
          HOSTS=$(nix flake show --json | jq -c '.nixosConfigurations | keys' | jq -c)
          echo "hosts=$HOSTS" >> $GITHUB_OUTPUT

  build:
    needs: check
    if: ${{ github.event_name != 'push' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        host: ${{ fromJSON(needs.check.outputs.hosts) }}
      fail-fast: false
    steps:
      - name: Initialize
        uses: spotdemo4/nix-init@702dfea250d4f6c157fa35c5bb63b5febdffbf3f # v1.27.1
        with:
          shell: check

      - name: Setup cache
        uses: spotdemo4/niks3-action@main
        with:
          audience: https://niks3.trev.zip
          max-concurrent-uploads: 10

      - name: Build packages
        run: |
          nix-fast-build \
            --skip-cached \
            --no-nom \
            --flake ".#nixosConfigurations.${{ matrix.host }}.config.system.build.toplevel"

  build-status:
    needs: [check, build]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Failed
        if: ${{ (contains(needs.*.result, 'failure')) || (contains(needs.*.result, 'cancelled')) }}
        run: exit 1

      - name: Success
        run: echo "All jobs completed successfully."
